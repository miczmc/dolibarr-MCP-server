#!/usr/bin/env python3
"""
Script de test pour trouver la bonne URL API Dolibarr
"""

import asyncio
import httpx

# Configuration
BASE_DOMAIN = "https://dolibarr.com"
API_KEY = "votre_cle_api_ici"  # Remplacez par votre vraie clÃ©

# URLs candidates Ã  tester
CANDIDATE_URLS = [
    f"{BASE_DOMAIN}/dolibarr/api/index.php",
    f"{BASE_DOMAIN}/dolibarr/api",
    f"{BASE_DOMAIN}/dolibarr/htdocs/api/index.php",
    f"{BASE_DOMAIN}/api/index.php",
    f"{BASE_DOMAIN}/api",
]

async def test_api_url(base_url: str, api_key: str) -> bool:
    """Test une URL API Dolibarr"""
    
    headers = {
        "DOLAPIKEY": api_key,
        "Content-Type": "application/json"
    }
    
    # URLs de test Ã  essayer
    test_endpoints = [
        "",  # URL de base
        "/contacts?limit=1",
        "/thirdparties?limit=1",
        "/users/info"
    ]
    
    async with httpx.AsyncClient() as client:
        for endpoint in test_endpoints:
            test_url = f"{base_url.rstrip('/')}{endpoint}"
            
            try:
                print(f"ğŸ” Test: {test_url}")
                response = await client.get(test_url, headers=headers, timeout=10)
                
                print(f"   ğŸ“Š Status: {response.status_code}")
                
                if response.status_code == 200:
                    print(f"   âœ… SuccÃ¨s ! RÃ©ponse: {len(response.text)} chars")
                    if endpoint:  # Si on teste un endpoint spÃ©cifique
                        try:
                            data = response.json()
                            if isinstance(data, list):
                                print(f"   ğŸ“‹ DonnÃ©es: {len(data)} Ã©lÃ©ments")
                            else:
                                print(f"   ğŸ“‹ DonnÃ©es: {type(data)}")
                        except:
                            print(f"   ğŸ“‹ RÃ©ponse non-JSON")
                    return True
                    
                elif response.status_code == 401:
                    print(f"   ğŸ”‘ Erreur d'authentification (clÃ© API incorrecte?)")
                    
                elif response.status_code == 404:
                    print(f"   âŒ Endpoint non trouvÃ©")
                    
                else:
                    print(f"   âš ï¸  Autre erreur: {response.status_code}")
                    
            except httpx.TimeoutException:
                print(f"   â±ï¸  Timeout")
            except Exception as e:
                print(f"   ğŸ’¥ Erreur: {str(e)}")
        
        return False

async def main():
    """Fonction principale de test"""
    
    print("ğŸ” Recherche de la bonne URL API Dolibarr")
    print("=" * 50)
    
    if API_KEY == "votre_cle_api_ici":
        print("âŒ Veuillez configurer votre clÃ© API dans le script")
        return
    
    print(f"ğŸ”‘ ClÃ© API: {'*' * (len(API_KEY) - 4) + API_KEY[-4:] if len(API_KEY) > 4 else '***'}")
    print()
    
    working_urls = []
    
    for base_url in CANDIDATE_URLS:
        print(f"ğŸ§ª Test de l'URL de base: {base_url}")
        print("-" * 40)
        
        success = await test_api_url(base_url, API_KEY)
        
        if success:
            working_urls.append(base_url)
            print(f"âœ… URL fonctionnelle trouvÃ©e: {base_url}")
        else:
            print(f"âŒ URL non fonctionnelle: {base_url}")
        
        print()
    
    print("=" * 50)
    print("ğŸ“‹ RÃ©sultats:")
    
    if working_urls:
        print(f"âœ… {len(working_urls)} URL(s) fonctionnelle(s) trouvÃ©e(s):")
        for url in working_urls:
            print(f"   ğŸ”— {url}")
        
        print()
        print("ğŸ”§ Configuration recommandÃ©e pour .env:")
        print(f"DOLIBARR_BASE_URL={working_urls[0]}")
        print(f"DOLIBARR_API_KEY={API_KEY}")
        
    else:
        print("âŒ Aucune URL fonctionnelle trouvÃ©e")
        print()
        print("ğŸ”§ VÃ©rifications Ã  faire:")
        print("1. Module API REST activÃ© dans Dolibarr?")
        print("2. ClÃ© API correcte?")
        print("3. Permissions utilisateur suffisantes?")
        print("4. Firewall/sÃ©curitÃ© qui bloque?")

if __name__ == "__main__":
    asyncio.run(main())
